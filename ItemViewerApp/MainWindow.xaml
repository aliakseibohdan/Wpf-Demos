<Window x:Class="ItemViewerApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ItemViewerApp.ViewModel"
        xmlns:util="clr-namespace:ItemViewerApp.Utility"
        
        xmlns:custom="clr-namespace:CustomControls;assembly=CustomControls" 
        
        Title="Item Viewer" Height="500" Width="800"
        PreviewMouseLeftButtonDown="Window_PreviewMouseLeftButtonDown">

    <Window.DataContext>
        <local:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>

        <util:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <util:ErrorToBrushConverter x:Key="ErrorToBrushConverter"/>

        <Style x:Key="AddNewTileStyle" TargetType="Button">
            <Setter Property="Background" Value="#F5F5F5"/>
            <Setter Property="BorderBrush" Value="#E0E0E0"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="Width" Value="120"/>
            <Setter Property="Height" Value="100"/>
            <Setter Property="Margin" Value="5"/>
            <Setter Property="Content" Value="+ Add New"/>
            <Setter Property="FontSize" Value="18"/>
        </Style>

        <DataTemplate DataType="{x:Type local:MyObjectViewModel}">
            <Border Width="120" Height="100" Margin="5" 
                    BorderBrush="{Binding NameError, Converter={StaticResource ErrorToBrushConverter}}" 
                    BorderThickness="2" CornerRadius="5"
                    Background="White" Focusable="True"
                    MouseLeftButtonUp="ItemTile_MouseLeftButtonUp"
                    GotFocus="ItemTile_GotFocus"
                    LostFocus="ItemTile_LostFocus"         
                    PreviewKeyDown="ItemTile_PreviewKeyDown" 
                    ToolTip="{Binding NameError}">

                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Delete"
                                  Command="{Binding DataContext.RemoveItemCommand, Source={x:Reference ItemsListBox}}"
                                  CommandParameter="{Binding}"/>
                    </ContextMenu>
                </Border.ContextMenu>

                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0">
                        <TextBlock HorizontalAlignment="Center" Margin="0,5,0,0" 
                                   Text="{Binding Name}" 
                                   Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>

                        <TextBox Margin="5,5,5,0" HorizontalAlignment="Stretch"
                                 Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}" 
                                 Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </Grid>

                    <StackPanel Grid.Row="1" VerticalAlignment="Center" Margin="0,5,0,0">

                        <TextBlock HorizontalAlignment="Center" FontSize="20" FontWeight="Bold"
                                   Text="{Binding ItemsCount}"
                                   Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}"/>

                        <custom:IntegerUpDown 
                            CurrentValue="{Binding ItemsCount, Mode=TwoWay}"
                            MinimumValue="1"
                            MaximumValue="10" 
                            Width="80" Height="24"
                            HorizontalAlignment="Center"
                            Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </DataTemplate>

        <DataTemplate DataType="{x:Type local:AddNewMarker}">
            <Button Style="{StaticResource AddNewTileStyle}" 
                    Command="{Binding DataContext.AddNewCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"/>
        </DataTemplate>

    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Orientation="Horizontal" Margin="10" Grid.Row="0">
            <TextBlock Text="Count: " VerticalAlignment="Center" Margin="0,0,5,0"/>
            <TextBox Text="{Binding GenerationCount, UpdateSourceTrigger=PropertyChanged}" 
                     Width="50" Height="25" VerticalContentAlignment="Center" Margin="0,0,10,0"/>
            <Button Content="Generate" Command="{Binding GenerateCommand}" Padding="10,0"/>
        </StackPanel>

        <Border Grid.Row="1" BorderBrush="Gray" BorderThickness="1" Margin="10">
            <ListBox x:Name="ItemsListBox"
                     ItemsSource="{Binding CompositeItems}" 
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     BorderThickness="0">
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel/>
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
            </ListBox>
        </Border>

        <TextBlock Grid.Row="2" HorizontalAlignment="Right" Margin="10"
                   FontSize="16" FontWeight="Bold">
            <Run Text="Total: "/>
            <Run Text="{Binding TotalCount}" Foreground="DodgerBlue"/>
        </TextBlock>
    </Grid>
</Window>